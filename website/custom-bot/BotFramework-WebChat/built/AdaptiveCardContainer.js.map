{"version":3,"file":"AdaptiveCardContainer.js","sourceRoot":"","sources":["../src/AdaptiveCardContainer.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { findDOMNode } from 'react-dom';\nimport { connect } from 'react-redux';\nimport { Action, AdaptiveCard, HostConfig, IValidationError, OpenUrlAction, SubmitAction } from 'adaptivecards';\nimport { IAction, IAdaptiveCard, IOpenUrlAction, IShowCardAction, ISubmitAction } from 'adaptivecards/lib/schema';\nimport { CardAction } from 'botframework-directlinejs/built/directLine';\nimport { classList, IDoCardAction } from './Chat';\nimport { AjaxResponse, AjaxRequest } from 'rxjs/observable/dom/AjaxObservable';\nimport * as adaptivecardsHostConfig from '../adaptivecards-hostconfig.json';\nimport * as konsole from './Konsole';\nimport { ChatState, AdaptiveCardsState } from './Store';\n\nexport interface Props {\n    className?: string,\n    hostConfig: HostConfig,\n    jsonCard?: IAdaptiveCard,\n    nativeCard?: AdaptiveCard,\n    onCardAction: IDoCardAction,\n    onClick?: (e: React.MouseEvent<HTMLElement>) => void,\n    onImageLoad?: () => any,\n}\n\nexport interface State {\n    errors?: string[]\n}\n\nexport interface BotFrameworkCardAction extends CardAction {\n    __isBotFrameworkCardAction: boolean\n}\n\nconst defaultHostConfig = new HostConfig(adaptivecardsHostConfig);\n\nfunction cardWithoutHttpActions(card: IAdaptiveCard) {\n    if (!card.actions) {\n        return card;\n    }\n\n    const nextActions: (IOpenUrlAction | IShowCardAction | ISubmitAction)[] = card.actions.reduce((nextActions, action) => {\n        // Filter out HTTP action buttons\n        switch (action.type) {\n            case 'Action.Submit':\n                break;\n\n            case 'Action.ShowCard':\n                nextActions.push({\n                    ...action,\n                    card: cardWithoutHttpActions(action.card)\n                });\n\n                break;\n\n            default:\n                nextActions.push(action);\n\n                break;\n        }\n\n        return nextActions;\n    }, []);\n\n    return { ...card, nextActions };\n}\n\nclass AdaptiveCardContainer extends React.Component<Props, State> {\n    private divRef: React.ReactInstance;\n\n    constructor(props: Props) {\n        super(props);\n\n        this.handleImageLoad = this.handleImageLoad.bind(this);\n        this.onClick = this.onClick.bind(this);\n        this.saveDiv = this.saveDiv.bind(this);\n    }\n\n    private saveDiv(divRef: React.ReactInstance) {\n        this.divRef = divRef;\n    }\n\n    private onClick(e: React.MouseEvent<HTMLElement>) {\n        if (!this.props.onClick) {\n            return;\n        }\n\n        //do not allow form elements to trigger a parent click event\n        switch ((e.target as HTMLElement).tagName) {\n            case 'A':\n            case 'AUDIO':\n            case 'VIDEO':\n            case 'BUTTON':\n            case 'INPUT':\n            case 'LABEL':\n            case 'TEXTAREA':\n            case 'SELECT':\n                break;\n\n            default:\n                this.props.onClick(e);\n        }\n    }\n\n    private onExecuteAction(action: Action) {\n        if (action instanceof OpenUrlAction) {\n            window.open(action.url);\n        } else if (action instanceof SubmitAction) {\n            if (action.data !== undefined) {\n                if (typeof action.data === 'object' && (action.data as BotFrameworkCardAction).__isBotFrameworkCardAction) {\n                    const cardAction = (action.data as BotFrameworkCardAction);\n\n                    this.props.onCardAction(cardAction.type, cardAction.value);\n                } else {\n                    this.props.onCardAction(typeof action.data === 'string' ? 'imBack' : 'postBack', action.data);\n                }\n            }\n        }\n    }\n\n    componentDidMount() {\n        this.mountAdaptiveCards();\n    }\n\n    componentDidUpdate(prevProps: Props) {\n        if (\n            prevProps.hostConfig !== this.props.hostConfig\n            || prevProps.jsonCard !== this.props.jsonCard\n            || prevProps.nativeCard !== this.props.nativeCard\n        ) {\n            this.unmountAdaptiveCards();\n            this.mountAdaptiveCards();\n        }\n    }\n\n    handleImageLoad() {\n        this.props.onImageLoad && this.props.onImageLoad.apply(this, arguments);\n    }\n\n    unmountAdaptiveCards() {\n        const divElement = findDOMNode(this.divRef);\n\n        [].forEach.call(divElement.children, (child: any) => divElement.removeChild(child));\n    }\n\n    mountAdaptiveCards() {\n        const adaptiveCard = this.props.nativeCard || new AdaptiveCard();\n\n        adaptiveCard.hostConfig = this.props.hostConfig || defaultHostConfig;\n\n        let errors: IValidationError[] = [];\n\n        if (!this.props.nativeCard && this.props.jsonCard) {\n            this.props.jsonCard.version = this.props.jsonCard.version || '0.5';\n            adaptiveCard.parse(cardWithoutHttpActions(this.props.jsonCard));\n            errors = adaptiveCard.validate();\n        }\n\n        adaptiveCard.onExecuteAction = (action) => this.onExecuteAction(action);\n\n        if (errors.length === 0) {\n            let renderedCard: HTMLElement;\n\n            try {\n                renderedCard = adaptiveCard.render();\n            } catch (e) {\n                const ve: IValidationError = {\n                    error: -1,\n                    message: e\n                };\n\n                errors.push(ve);\n\n                if (e.stack) {\n                    ve.message += '\\n' + e.stack;\n                }\n            }\n\n            if (renderedCard) {\n                if (this.props.onImageLoad) {\n                    var imgs = renderedCard.querySelectorAll('img');\n\n                    if (imgs && imgs.length > 0) {\n                        Array.prototype.forEach.call(imgs, (img: HTMLImageElement) => {\n                            img.addEventListener('load', this.handleImageLoad);\n                        });\n                    }\n                }\n\n                findDOMNode(this.divRef).appendChild(renderedCard);\n\n                return;\n            }\n        }\n\n        if (errors.length > 0) {\n            console.log('Error(s) rendering AdaptiveCard:');\n            errors.forEach(e => console.log(e.message));\n            this.setState({ errors: errors.map(e => e.message) });\n        }\n    }\n\n    render() {\n        let wrappedChildren: JSX.Element;\n        const hasErrors = this.state && this.state.errors && this.state.errors.length > 0;\n\n        if (hasErrors) {\n            wrappedChildren = (\n                <div>\n                    <svg className=\"error-icon\" viewBox=\"0 0 15 12.01\">\n                        <path d=\"M7.62 8.63v-.38H.94a.18.18 0 0 1-.19-.19V.94A.18.18 0 0 1 .94.75h10.12a.18.18 0 0 1 .19.19v3.73H12V.94a.91.91 0 0 0-.07-.36 1 1 0 0 0-.5-.5.91.91 0 0 0-.37-.08H.94a.91.91 0 0 0-.37.07 1 1 0 0 0-.5.5.91.91 0 0 0-.07.37v7.12a.91.91 0 0 0 .07.36 1 1 0 0 0 .5.5.91.91 0 0 0 .37.08h6.72c-.01-.12-.04-.24-.04-.37z M11.62 5.26a3.27 3.27 0 0 1 1.31.27 3.39 3.39 0 0 1 1.8 1.8 3.36 3.36 0 0 1 0 2.63 3.39 3.39 0 0 1-1.8 1.8 3.36 3.36 0 0 1-2.62 0 3.39 3.39 0 0 1-1.8-1.8 3.36 3.36 0 0 1 0-2.63 3.39 3.39 0 0 1 1.8-1.8 3.27 3.27 0 0 1 1.31-.27zm0 6a2.53 2.53 0 0 0 1-.21A2.65 2.65 0 0 0 14 9.65a2.62 2.62 0 0 0 0-2 2.65 2.65 0 0 0-1.39-1.39 2.62 2.62 0 0 0-2 0A2.65 2.65 0 0 0 9.2 7.61a2.62 2.62 0 0 0 0 2A2.65 2.65 0 0 0 10.6 11a2.53 2.53 0 0 0 1.02.26zM13 7.77l-.86.86.86.86-.53.53-.86-.86-.86.86-.53-.53.86-.86-.86-.86.53-.53.86.86.86-.86zM1.88 7.13h2.25V4.88H1.88zm.75-1.5h.75v.75h-.75zM5.63 2.63h4.5v.75h-4.5zM1.88 4.13h2.25V1.88H1.88zm.75-1.5h.75v.75h-.75zM9 5.63H5.63v.75h2.64A4 4 0 0 1 9 5.63z\" />\n                    </svg>\n                    <div className=\"error-text\">Can't render card</div>\n                </div>\n            );\n        } else if (this.props.children) {\n            wrappedChildren = (\n                <div className=\"non-adaptive-content\">\n                    { this.props.children }\n                </div>\n            );\n        } else {\n            wrappedChildren = null;\n        }\n\n        return (\n            <div\n                className={ classList('wc-card', 'wc-adaptive-card', this.props.className, hasErrors && 'error') }\n                onClick={ this.onClick }\n            >\n                { wrappedChildren }\n                <div ref={ this.saveDiv } />\n            </div>\n        )\n    }\n}\n\nexport default connect(\n    (state: ChatState) => ({\n        hostConfig: state.adaptiveCards.hostConfig\n    }),\n    {},\n    (stateProps: any, dispatchProps: any, ownProps: any): Props => ({\n        ...ownProps,\n        ...stateProps\n    })\n)(AdaptiveCardContainer);\n"]}